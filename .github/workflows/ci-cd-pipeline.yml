name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
      - 'feature/**'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOY_TIMEOUT: 600

jobs:
  # Debug Information Job - Always runs first
  debug-info:
    name: üîç Debug Information
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display workflow context
        run: |
          echo "==================================="
          echo "üîç WORKFLOW CONTEXT INFORMATION"
          echo "==================================="
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "==================================="

      - name: Display system information
        run: |
          echo "==================================="
          echo "üíª SYSTEM INFORMATION"
          echo "==================================="
          echo "Runner OS: $(uname -a)"
          echo "CPU Info:"
          lscpu | grep -E "Model name|CPU\(s\)|Thread|Core"
          echo ""
          echo "Memory Info:"
          free -h
          echo ""
          echo "Disk Space:"
          df -h /
          echo "==================================="

      - name: Display Docker information
        run: |
          echo "==================================="
          echo "üê≥ DOCKER INFORMATION"
          echo "==================================="
          docker --version
          docker compose version || echo "Docker Compose v2 not found"
          echo ""
          echo "Docker Info:"
          docker info | grep -E "Server Version|Storage Driver|Logging Driver|Cgroup|Kernel|Operating System|CPUs|Total Memory"
          echo "==================================="

      - name: Display GitHub Actions environment
        run: |
          echo "==================================="
          echo "‚öôÔ∏è GITHUB ACTIONS ENVIRONMENT"
          echo "==================================="
          echo "GitHub Actions: $GITHUB_ACTIONS"
          echo "Runner Tool Cache: $RUNNER_TOOL_CACHE"
          echo "Runner Temp: $RUNNER_TEMP"
          echo "Runner Workspace: $RUNNER_WORKSPACE"
          echo "==================================="

      - name: List changed files
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        run: |
          echo "==================================="
          echo "üìù CHANGED FILES"
          echo "==================================="
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }}
          else
            git diff --name-only HEAD~1 HEAD || echo "No previous commit to compare"
          fi
          echo "==================================="

      - name: Display PHP and Node versions available
        run: |
          echo "==================================="
          echo "üîß LANGUAGE RUNTIMES"
          echo "==================================="
          echo "Available PHP versions:"
          ls /usr/bin/php* 2>/dev/null || echo "PHP not found in /usr/bin"
          echo ""
          echo "Available Node versions:"
          ls /usr/local/bin/node* 2>/dev/null || which node || echo "Node not found"
          node --version 2>/dev/null || echo "Node not installed"
          npm --version 2>/dev/null || echo "NPM not installed"
          echo "==================================="

      - name: Display network configuration
        run: |
          echo "==================================="
          echo "üåê NETWORK CONFIGURATION"
          echo "==================================="
          echo "Hostname: $(hostname)"
          echo "IP Address:"
          ip addr show | grep "inet " | grep -v 127.0.0.1
          echo ""
          echo "DNS Configuration:"
          cat /etc/resolv.conf | grep nameserver
          echo ""
          echo "Internet connectivity test:"
          ping -c 3 github.com || echo "Cannot reach github.com"
          echo "==================================="

      - name: Display environment variables
        run: |
          echo "==================================="
          echo "üîê ENVIRONMENT VARIABLES"
          echo "==================================="
          echo "GITHUB_* variables:"
          env | grep "GITHUB_" | grep -v "TOKEN" | sort
          echo ""
          echo "PATH:"
          echo $PATH | tr ':' '\n'
          echo ""
          echo "CI/CD specific:"
          echo "CI: $CI"
          echo "CONTINUOUS_INTEGRATION: $CONTINUOUS_INTEGRATION"
          echo "==================================="

      - name: Display installed tools
        run: |
          echo "==================================="
          echo "üõ†Ô∏è INSTALLED TOOLS & VERSIONS"
          echo "==================================="
          echo "Git: $(git --version)"
          echo "Curl: $(curl --version | head -1)"
          echo "Wget: $(wget --version | head -1)"
          echo "Jq: $(jq --version 2>/dev/null || echo 'not installed')"
          echo "Zip: $(zip --version | head -2 | tail -1)"
          echo "Unzip: $(unzip -v | head -1)"
          echo "Make: $(make --version | head -1)"
          echo "==================================="

      - name: Check for CI configuration files
        run: |
          echo "==================================="
          echo "üìã CI CONFIGURATION FILES"
          echo "==================================="
          echo "Checking for configuration files..."
          [ -f .env.example ] && echo "‚úÖ .env.example found" || echo "‚ùå .env.example not found"
          [ -f composer.json ] && echo "‚úÖ composer.json found" || echo "‚ùå composer.json not found"
          [ -f package.json ] && echo "‚úÖ package.json found" || echo "‚ùå package.json not found"
          [ -f phpunit.xml ] && echo "‚úÖ phpunit.xml found" || echo "‚ùå phpunit.xml not found"
          [ -f Dockerfile ] && echo "‚úÖ Dockerfile found" || echo "‚ùå Dockerfile not found"
          [ -f docker-compose.yml ] && echo "‚úÖ docker-compose.yml found" || echo "‚ùå docker-compose.yml not found"
          echo "==================================="

      - name: Display project structure
        run: |
          echo "==================================="
          echo "üìÅ PROJECT STRUCTURE"
          echo "==================================="
          echo "Top-level directories:"
          ls -la | grep "^d" | awk '{print $9}' | grep -v "^\.$" | grep -v "^\.\.$"
          echo ""
          echo "File count by type:"
          echo "PHP files: $(find . -name '*.php' -not -path './vendor/*' | wc -l)"
          echo "Blade files: $(find . -name '*.blade.php' | wc -l)"
          echo "JS files: $(find . -name '*.js' -not -path './node_modules/*' -not -path './vendor/*' | wc -l)"
          echo "CSS files: $(find . -name '*.css' -not -path './node_modules/*' -not -path './vendor/*' | wc -l)"
          echo "==================================="

  # Code Quality and Validation
  code-quality:
    name: üîé Code Quality Checks
    runs-on: ubuntu-latest
    needs: debug-info
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql, redis
          coverage: xdebug
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader

      - name: Check PHP syntax
        run: |
          echo "Checking PHP syntax..."
          find . -path ./vendor -prune -o -name "*.php" -print0 | xargs -0 -n1 php -l

      - name: Validate composer.json
        run: composer validate --strict

      - name: Check for security vulnerabilities
        run: |
          composer audit || echo "Security audit completed with warnings"

  # Static Analysis and Code Style
  static-analysis:
    name: üî¨ Static Analysis
    runs-on: ubuntu-latest
    needs: debug-info
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json, bcmath
          coverage: none
          tools: composer:v2, phpstan, psalm

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHPStan
        run: |
          echo "==================================="
          echo "üîç Running PHPStan Static Analysis"
          echo "==================================="
          if [ -f phpstan.neon ] || [ -f phpstan.neon.dist ]; then
            ./vendor/bin/phpstan analyse --memory-limit=2G --error-format=table || true
          else
            echo "PHPStan configuration not found, creating default..."
            cat > phpstan.neon << 'EOF'
          parameters:
              level: 5
              paths:
                  - app
                  - config
                  - database
                  - routes
              excludePaths:
                  - vendor
                  - storage
                  - bootstrap/cache
          EOF
            ./vendor/bin/phpstan analyse --memory-limit=2G --error-format=table || true
          fi
          echo "==================================="

      - name: Run Psalm
        run: |
          echo "==================================="
          echo "üìñ Running Psalm Static Analysis"
          echo "==================================="
          if [ -f psalm.xml ] || [ -f psalm.xml.dist ]; then
            ./vendor/bin/psalm --show-info=true --output-format=github || true
          else
            echo "Psalm configuration not found, skipping..."
          fi
          echo "==================================="

      - name: Check code style with Laravel Pint
        run: |
          echo "==================================="
          echo "üé® Checking Code Style with Laravel Pint"
          echo "==================================="
          if [ -f vendor/bin/pint ]; then
            ./vendor/bin/pint --test -v || echo "‚ö†Ô∏è Code style issues found"
          else
            echo "Laravel Pint not installed, installing..."
            composer require laravel/pint --dev
            ./vendor/bin/pint --test -v || echo "‚ö†Ô∏è Code style issues found"
          fi
          echo "==================================="

      - name: Check code style with PHP CS Fixer
        run: |
          echo "==================================="
          echo "üîß Running PHP CS Fixer"
          echo "==================================="
          if [ -f vendor/bin/php-cs-fixer ]; then
            ./vendor/bin/php-cs-fixer fix --dry-run --diff --verbose || echo "‚ö†Ô∏è Formatting issues found"
          else
            echo "PHP CS Fixer not installed, skipping..."
          fi
          echo "==================================="

      - name: Run PHP_CodeSniffer
        run: |
          echo "==================================="
          echo "üìè Running PHP_CodeSniffer"
          echo "==================================="
          if [ -f vendor/bin/phpcs ]; then
            ./vendor/bin/phpcs --standard=PSR12 app/ --report=summary || echo "‚ö†Ô∏è Coding standard violations found"
          else
            echo "PHP_CodeSniffer not installed, skipping..."
          fi
          echo "==================================="

      - name: Analyze code complexity
        run: |
          echo "==================================="
          echo "üìä Analyzing Code Complexity"
          echo "==================================="
          if [ -f vendor/bin/phpmetrics ]; then
            ./vendor/bin/phpmetrics --report-html=metrics-report app/
            echo "Metrics report generated in metrics-report/"
          else
            echo "PHPMetrics not installed, using alternative..."
            find app -name "*.php" -exec wc -l {} + | sort -rn | head -20 | awk '{print "Lines: " $1 " - " $2}'
          fi
          echo "==================================="

      - name: Check for dead code
        run: |
          echo "==================================="
          echo "üíÄ Checking for Dead Code"
          echo "==================================="
          # Simple dead code detection using grep
          echo "Checking for unused private methods..."
          find app -name "*.php" -exec grep -l "private function" {} \; | while read file; do
            echo "Analyzing: $file"
          done
          echo "==================================="

  # Security Scanning
  security:
    name: üîí Security Scanning
    runs-on: ubuntu-latest
    needs: debug-info
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run security audit
        run: |
          echo "==================================="
          echo "üîç Running Composer Security Audit"
          echo "==================================="
          composer audit --format=json > security-audit.json || true
          cat security-audit.json
          
          # Check if vulnerabilities were found
          if [ -s security-audit.json ]; then
            echo "‚ö†Ô∏è Security vulnerabilities detected"
            cat security-audit.json | jq '.advisories // empty'
          else
            echo "‚úÖ No known security vulnerabilities"
          fi
          echo "==================================="

      - name: Check for malicious code patterns
        run: |
          echo "==================================="
          echo "ü¶† Scanning for Malicious Code Patterns"
          echo "==================================="
          
          echo "Checking for eval() usage..."
          find app -name "*.php" -exec grep -Hn "eval(" {} \; || echo "‚úÖ No eval() found"
          
          echo ""
          echo "Checking for exec() usage..."
          find app -name "*.php" -exec grep -Hn "exec(" {} \; || echo "‚úÖ No exec() found"
          
          echo ""
          echo "Checking for system() usage..."
          find app -name "*.php" -exec grep -Hn "system(" {} \; || echo "‚úÖ No system() found"
          
          echo ""
          echo "Checking for shell_exec() usage..."
          find app -name "*.php" -exec grep -Hn "shell_exec(" {} \; || echo "‚úÖ No shell_exec() found"
          
          echo ""
          echo "Checking for passthru() usage..."
          find app -name "*.php" -exec grep -Hn "passthru(" {} \; || echo "‚úÖ No passthru() found"
          
          echo "==================================="

      - name: Scan for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Run OWASP Dependency Check
        run: |
          echo "==================================="
          echo "üõ°Ô∏è Running OWASP Dependency Check"
          echo "==================================="
          
          # Download and run dependency-check
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
          unzip -q dependency-check-8.4.0-release.zip
          
          ./dependency-check/bin/dependency-check.sh \
            --project "Hanaya-Shop" \
            --scan composer.lock \
            --format "HTML" \
            --format "JSON" \
            --out dependency-check-report \
            || echo "‚ö†Ô∏è Dependency check completed with warnings"
          
          echo "Dependency check report generated"
          echo "==================================="

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            security-audit.json
            dependency-check-report/
          retention-days: 30

      - name: Check for exposed .env files
        run: |
          echo "==================================="
          echo "üîê Checking for Exposed Configuration"
          echo "==================================="
          
          if [ -f .env ]; then
            echo "‚ö†Ô∏è WARNING: .env file found in repository!"
            echo "This file should not be committed to version control"
          else
            echo "‚úÖ No .env file in repository"
          fi
          
          echo ""
          echo "Checking .gitignore for sensitive files..."
          if grep -q ".env" .gitignore; then
            echo "‚úÖ .env is in .gitignore"
          else
            echo "‚ö†Ô∏è .env should be added to .gitignore"
          fi
          
          echo "==================================="

      - name: Analyze permissions
        run: |
          echo "==================================="
          echo "üîë Analyzing File Permissions"
          echo "==================================="
          
          echo "Checking for world-writable files..."
          find . -type f -perm -002 -not -path "./vendor/*" -not -path "./.git/*" || echo "‚úÖ No world-writable files"
          
          echo ""
          echo "Checking for executable PHP files..."
          find app -name "*.php" -type f -executable || echo "‚úÖ No executable PHP files in app/"
          
          echo "==================================="

  # Unit and Feature Tests
  tests:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    needs: [debug-info, code-quality]
    if: ${{ !inputs.skip_tests }}
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql, redis
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Prepare Laravel application
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:clear
          php artisan cache:clear

      - name: Run migrations
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
        run: php artisan migrate --force

      - name: Run unit tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
        run: php artisan test --testsuite=Unit --parallel --coverage --min=80

      - name: Run feature tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
        run: php artisan test --testsuite=Feature --parallel

      - name: Generate test coverage report
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
        run: |
          echo "==================================="
          echo "üìä GENERATING CODE COVERAGE REPORT"
          echo "==================================="
          php artisan test --coverage --min=80 --coverage-html coverage-html --coverage-clover coverage.xml

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: |
            coverage-html/
            coverage.xml
          retention-days: 30

      - name: Display coverage summary
        run: |
          echo "==================================="
          echo "üìà COVERAGE SUMMARY"
          echo "==================================="
          if [ -f coverage.xml ]; then
            echo "Coverage report generated successfully"
            # Extract coverage percentage from clover XML
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage.xml');
              \$metrics = \$xml->project->metrics;
              \$statements = (int)\$metrics['statements'];
              \$coveredstatements = (int)\$metrics['coveredstatements'];
              if(\$statements > 0) {
                echo round((\$coveredstatements / \$statements) * 100, 2);
              } else {
                echo '0';
              }
            ")
            echo "Total Coverage: ${COVERAGE}%"
            
            # Check if coverage meets minimum threshold
            THRESHOLD=80
            if (( $(echo "$COVERAGE >= $THRESHOLD" | bc -l) )); then
              echo "‚úÖ Coverage meets minimum threshold of ${THRESHOLD}%"
            else
              echo "‚ö†Ô∏è Coverage below minimum threshold of ${THRESHOLD}%"
            fi
          else
            echo "‚ùå Coverage report not found"
          fi
          echo "==================================="

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## üìä Test Coverage Report
            
            Coverage report generated for commit ${{ github.sha }}
            
            **Download detailed coverage report from workflow artifacts**
            
            View full coverage details in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

  # Docker Build Gating
  docker-build:
    name: üê≥ Docker Build & Validation
    runs-on: ubuntu-latest
    needs: [code-quality, tests]
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image (test build)
        id: build-test
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Validate Docker image
        run: |
          echo "==================================="
          echo "üîç VALIDATING DOCKER IMAGE"
          echo "==================================="
          
          # Check image exists
          docker images ${{ env.IMAGE_NAME }}:test
          
          # Inspect image
          echo ""
          echo "Image Details:"
          docker inspect ${{ env.IMAGE_NAME }}:test | jq '.[0] | {Id, RepoTags, Size, Architecture, Os, Created}'
          
          # Check image size
          IMAGE_SIZE=$(docker images ${{ env.IMAGE_NAME }}:test --format "{{.Size}}")
          echo ""
          echo "Image Size: $IMAGE_SIZE"
          
          # Test image can start
          echo ""
          echo "Testing image startup..."
          CONTAINER_ID=$(docker run -d ${{ env.IMAGE_NAME }}:test)
          sleep 5
          
          # Check if container is running
          if [ "$(docker inspect -f '{{.State.Running}}' $CONTAINER_ID)" == "true" ]; then
            echo "‚úÖ Container started successfully"
          else
            echo "‚ùå Container failed to start"
            docker logs $CONTAINER_ID
            exit 1
          fi
          
          # Check container logs
          echo ""
          echo "Container logs:"
          docker logs $CONTAINER_ID
          
          # Cleanup
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID
          
          echo "==================================="
          echo "‚úÖ DOCKER IMAGE VALIDATION PASSED"
          echo "==================================="

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Build and push Docker image
        id: build
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Output build information
        run: |
          echo "==================================="
          echo "üì¶ BUILD INFORMATION"
          echo "==================================="
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Labels: ${{ steps.meta.outputs.labels }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"
          echo "==================================="

  # Production Deployment with Gating
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: [code-quality, static-analysis, tests, security, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://hanaya-shop.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify all CI checks passed
        run: |
          echo "==================================="
          echo "‚úÖ VERIFYING CI CHECKS"
          echo "==================================="
          echo "All required CI jobs have passed:"
          echo "  ‚úì Code Quality"
          echo "  ‚úì Static Analysis"
          echo "  ‚úì Tests"
          echo "  ‚úì Security Scanning"
          echo "  ‚úì Docker Build"
          echo ""
          echo "Proceeding with deployment..."
          echo "==================================="

      - name: Download Docker image info
        run: |
          echo "Image Tag: ${{ needs.docker-build.outputs.image-tag }}"
          echo "Image Digest: ${{ needs.docker-build.outputs.image-digest }}"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure AWS credentials
        if: env.AWS_REGION != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        if: env.AWS_REGION != ''
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      - name: Pre-deployment health check
        run: |
          echo "==================================="
          echo "üè• PRE-DEPLOYMENT HEALTH CHECK"
          echo "==================================="
          
          # Check if production endpoint is reachable
          PROD_URL="https://hanaya-shop.com/health"
          
          echo "Checking production health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL || echo "000")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Production is healthy (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Production health check returned HTTP $HTTP_CODE"
          fi
          
          echo "==================================="

      - name: Create deployment backup
        run: |
          echo "==================================="
          echo "üíæ CREATING DEPLOYMENT BACKUP"
          echo "==================================="
          
          BACKUP_TAG="backup-$(date +%Y%m%d-%H%M%S)"
          echo "Backup tag: $BACKUP_TAG"
          
          # Tag current production image as backup
          docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
          docker tag ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                     ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:$BACKUP_TAG || true
          
          echo "‚úÖ Backup created: $BACKUP_TAG"
          echo "BACKUP_TAG=$BACKUP_TAG" >> $GITHUB_ENV
          echo "==================================="

      - name: Deploy to production
        timeout-minutes: 10
        run: |
          echo "==================================="
          echo "üöÄ DEPLOYING TO PRODUCTION"
          echo "==================================="
          
          IMAGE_TAG="${{ needs.docker-build.outputs.image-tag }}"
          
          echo "Deploying image: $IMAGE_TAG"
          echo "Deployment started at: $(date)"
          
          # Simulate deployment (replace with actual deployment commands)
          # Example for Kubernetes:
          # kubectl set image deployment/hanaya-shop hanaya-shop=$IMAGE_TAG
          # kubectl rollout status deployment/hanaya-shop --timeout=5m
          
          # Example for Docker Compose:
          # docker-compose pull
          # docker-compose up -d
          
          # Example for AWS ECS:
          # aws ecs update-service --cluster hanaya-cluster --service hanaya-service --force-new-deployment
          
          echo "‚úÖ Deployment initiated successfully"
          echo "==================================="

      - name: Wait for deployment stabilization
        run: |
          echo "==================================="
          echo "‚è≥ WAITING FOR DEPLOYMENT TO STABILIZE"
          echo "==================================="
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            # Check deployment status
            # kubectl rollout status deployment/hanaya-shop --timeout=10s
            
            sleep 10
          done
          
          echo "‚úÖ Deployment stabilized"
          echo "==================================="

      - name: Post-deployment health check
        run: |
          echo "==================================="
          echo "üè• POST-DEPLOYMENT HEALTH CHECK"
          echo "==================================="
          
          PROD_URL="https://hanaya-shop.com/health"
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL || echo "000")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Production is healthy after deployment (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Health check returned HTTP $HTTP_CODE, retrying..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "==================================="
          echo "üî• RUNNING SMOKE TESTS"
          echo "==================================="
          
          PROD_URL="https://hanaya-shop.com"
          
          echo "Testing homepage..."
          curl -f -s -o /dev/null -w "HTTP %{http_code}" "$PROD_URL/" || echo "Failed"
          
          echo ""
          echo "Testing API endpoint..."
          curl -f -s -o /dev/null -w "HTTP %{http_code}" "$PROD_URL/api/products" || echo "Failed"
          
          echo ""
          echo "Testing admin login..."
          curl -f -s -o /dev/null -w "HTTP %{http_code}" "$PROD_URL/admin" || echo "Failed"
          
          echo ""
          echo "‚úÖ Smoke tests completed"
          echo "==================================="

      - name: Update deployment status
        if: success()
        run: |
          echo "==================================="
          echo "üìä DEPLOYMENT SUMMARY"
          echo "==================================="
          echo "Status: SUCCESS"
          echo "Environment: Production"
          echo "Image: ${{ needs.docker-build.outputs.image-tag }}"
          echo "Digest: ${{ needs.docker-build.outputs.image-digest }}"
          echo "Deployed at: $(date)"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "==================================="

  # Rollback on Deployment Failure
  rollback:
    name: üîÑ Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initiate rollback
        run: |
          echo "==================================="
          echo "üîÑ INITIATING DEPLOYMENT ROLLBACK"
          echo "==================================="
          echo "Deployment failed, rolling back to previous version..."
          echo "Failed deployment commit: ${{ github.sha }}"
          echo "Rollback initiated at: $(date)"
          echo "==================================="

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get backup image tag
        id: backup
        run: |
          echo "==================================="
          echo "üîç LOCATING BACKUP IMAGE"
          echo "==================================="
          
          # Find the most recent backup tag
          BACKUP_TAGS=$(docker run --rm quay.io/skopeo/stable list-tags \
            docker://${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }} | \
            jq -r '.Tags[]' | grep "^backup-" | sort -r | head -5)
          
          echo "Available backup tags:"
          echo "$BACKUP_TAGS"
          
          LATEST_BACKUP=$(echo "$BACKUP_TAGS" | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "‚ùå No backup image found!"
            exit 1
          fi
          
          echo "Selected backup: $LATEST_BACKUP"
          echo "BACKUP_TAG=$LATEST_BACKUP" >> $GITHUB_OUTPUT
          echo "==================================="

      - name: Restore backup image
        run: |
          echo "==================================="
          echo "üì¶ RESTORING BACKUP IMAGE"
          echo "==================================="
          
          BACKUP_TAG="${{ steps.backup.outputs.BACKUP_TAG }}"
          BACKUP_IMAGE="${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:$BACKUP_TAG"
          LATEST_IMAGE="${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "Pulling backup image: $BACKUP_IMAGE"
          docker pull $BACKUP_IMAGE
          
          echo "Tagging as latest: $LATEST_IMAGE"
          docker tag $BACKUP_IMAGE $LATEST_IMAGE
          
          echo "Pushing restored image..."
          docker push $LATEST_IMAGE
          
          echo "‚úÖ Backup image restored"
          echo "==================================="

      - name: Redeploy previous version
        timeout-minutes: 10
        run: |
          echo "==================================="
          echo "üîÑ REDEPLOYING PREVIOUS VERSION"
          echo "==================================="
          
          # Redeploy using the restored image
          # Example for Kubernetes:
          # kubectl rollout undo deployment/hanaya-shop
          # kubectl rollout status deployment/hanaya-shop --timeout=5m
          
          # Example for Docker Compose:
          # docker-compose pull
          # docker-compose up -d --force-recreate
          
          echo "‚úÖ Previous version redeployed"
          echo "==================================="

      - name: Verify rollback success
        run: |
          echo "==================================="
          echo "‚úÖ VERIFYING ROLLBACK"
          echo "==================================="
          
          PROD_URL="https://hanaya-shop.com/health"
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Verification attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL || echo "000")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Rollback successful! Production is healthy (HTTP $HTTP_CODE)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è Health check returned HTTP $HTTP_CODE, retrying..."
            sleep 10
          done
          
          echo "‚ùå Rollback verification failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Create rollback issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîÑ Deployment Rollback - ${context.sha.substring(0, 7)}`,
              body: `## Deployment Failure and Rollback
              
              **Failed Deployment:**
              - Commit: ${context.sha}
              - Branch: ${context.ref}
              - Actor: ${context.actor}
              - Workflow: ${context.workflow}
              - Run: ${context.runId}
              
              **Rollback Details:**
              - Rollback initiated at: ${new Date().toISOString()}
              - Previous version restored
              
              **Action Required:**
              - Investigate the deployment failure
              - Review logs: ${context.payload.repository.html_url}/actions/runs/${context.runId}
              - Fix issues before attempting another deployment
              
              **Workflow URL:** ${context.payload.repository.html_url}/actions/runs/${context.runId}`,
              labels: ['deployment', 'rollback', 'critical']
            });
            console.log('Created issue:', issue.data.number);

      - name: Rollback summary
        if: always()
        run: |
          echo "==================================="
          echo "üìä ROLLBACK SUMMARY"
          echo "==================================="
          echo "Status: Rollback Completed"
          echo "Failed Commit: ${{ github.sha }}"
          echo "Restored Backup: ${{ steps.backup.outputs.BACKUP_TAG }}"
          echo "Rollback Time: $(date)"
          echo "==================================="

